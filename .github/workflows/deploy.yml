name: Deploy to AWS EC2

on:
  push:
    branches:
      - main # main 브랜치에 푸시되면 이 워크플로우가 트리거됩니다.

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2

    - name: Set up Node.js
      uses: actions/setup-node@v1
      with:
        node-version: '20.10.0' # Strapi에 적합한 Node.js 버전을 선택하세요.

    - name: Install pnpm
      run: npm install -g pnpm

    - name: Install Dependencies
      run: pnpm install

    - name: Copy files to EC2
      uses: appleboy/ssh-action@v0.1.6 # ssh 접속하는 오픈소스
      with:
        host: ${{ secrets.REMOTE_HOST }} # 인스턴스 IP
        username: ${{ secrets.REMOTE_USER }} # 우분투 아이디
        key: ${{ secrets.SSH_PRIVATE_KEY }} # ec2 instance pem key
        port: ${{ secrets.REMOTE_SSH_PORT }} # 접속포트
        script: | # 실행할 스크립트
          npm install -g pnpm
          npm install -g pm2
          chmod +x ~/services/komponents-backend/deploy.sh
          ~/services/komponents-backend/deploy.sh
